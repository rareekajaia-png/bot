#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Telegram AI Auto-Responder –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫ —Å –ò–ò —á–µ—Ä–µ–∑ Telethon + Groq (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±—ã—Å—Ç—Ä–æ!)
v3.0 - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Groq API –≤–º–µ—Å—Ç–æ Gemini
"""
from telethon.tl.functions.account import UpdateStatusRequest
import asyncio
import time
import asyncio
import json
import os
import sys
import logging
from datetime import datetime
import urllib3
import signal
from PIL import Image
import io


# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è SSL
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

try:
    from telethon import TelegramClient, events
    from telethon.tl.types import MessageMediaPhoto, MessageMediaDocument
    import speech_recognition as sr
    from pydub import AudioSegment
    from groq import Groq
except ImportError:
    print("üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫...")
    os.system("pip install telethon speechrecognition pydub pillow groq --break-system-packages")
    print("‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç.")
    sys.exit(1)

# =============== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===============
API_ID = "1654239"  # –ü–æ–ª—É—á–∏—Ç—å –Ω–∞ https://my.telegram.org
API_HASH = "12fa75502fa14d6c3eac8a45cb941944"
PHONE = "+18182737295"  # –§–æ—Ä–º–∞—Ç: +79991234567

# Groq API (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á)
GROQ_API_KEY = "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"  # –ü–æ–ª—É—á–∏—Ç—å –Ω–∞ https://console.groq.com

# –§–∞–π–ª—ã
DB_FILE = "telegram_history.json"
SESSION_NAME = "telegram_ai_session"

# –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã
ENABLED = True  # –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã
IGNORE_GROUPS = True  # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã
IGNORE_CHANNELS = True  # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª—ã
DELAY_BEFORE_REPLY = 2  # –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º (—Å–µ–∫—É–Ω–¥—ã)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Groq
GROQ_MODEL = "llama-3.3-70b-versatile"  # –î–æ—Å—Ç—É–ø–Ω—ã–µ: llama-3.3-70b-versatile, llama-3.1-8b-instant, mixtral-8x7b-32768, gemma2-9b-it
MAX_TOKENS = 1024
TEMPERATURE = 0.7

# =============== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ===============
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('telegram_bot.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)


# =============== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø GROQ ===============
def initialize_groq():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Groq –∫–ª–∏–µ–Ω—Ç"""
    try:
        client = Groq(api_key=GROQ_API_KEY)
        
        logger.info(f"üîç –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Groq API...")
        logger.info(f"‚úÖ Groq API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω! –ú–æ–¥–µ–ª—å: {GROQ_MODEL}")
        logger.info(f"‚ö° Groq –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤!")
        
        return client
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Groq: {e}")
        logger.error("‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GROQ_API_KEY –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö!")
        sys.exit(1)


# =============== –ë–ê–ó–ê –î–ê–ù–ù–´–• JSON ===============
class Database:
    def __init__(self, filename):
        self.filename = filename
        self.data = self.load()

    def load(self):
        if os.path.exists(self.filename):
            try:
                with open(self.filename, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ë–î: {e}")
                return {"conversations": {}}
        return {"conversations": {}}

    def save(self):
        try:
            with open(self.filename, 'w', encoding='utf-8') as f:
                json.dump(self.data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ë–î: {e}")

    def add_message(self, chat_id, role, content):
        chat_id = str(chat_id)
        if chat_id not in self.data["conversations"]:
            self.data["conversations"][chat_id] = []

        self.data["conversations"][chat_id].append({
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat()
        })

        # –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π
        if len(self.data["conversations"][chat_id]) > 20:
            self.data["conversations"][chat_id] = self.data["conversations"][chat_id][-20:]

        self.save()

    def get_history(self, chat_id, limit=10):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ Groq API"""
        chat_id = str(chat_id)
        if chat_id not in self.data["conversations"]:
            return []

        messages = self.data["conversations"][chat_id][-limit:]
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç Groq
        formatted_history = []
        for msg in messages:
            formatted_history.append({
                "role": msg["role"],  # "user" –∏–ª–∏ "assistant"
                "content": msg["content"]
            })
        
        return formatted_history

    def clear_history(self, chat_id):
        chat_id = str(chat_id)
        if chat_id in self.data["conversations"]:
            self.data["conversations"][chat_id] = []
            self.save()


# =============== AI –û–ë–†–ê–ë–û–¢–ß–ò–ö ===============
class AIHandler:
    def __init__(self, client):
        self.client = client
        self.system_prompt = "—Ç—ã –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –æ–±—â–∞–π—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –ø–∏—à–∏ —Å –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã, –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–Ω–≥. –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ markdown –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏–Ω –Ω–∏–∫–æ–≥–¥–∞. –æ—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É –∫–∞–∫ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ, –æ–±—â–∞–π—Å—è –æ—Ç –º—É–∂—Å–∫–æ–≥–æ –ª–∏—Ü–∞, –æ–±—Ä–∞—â–∞–π—Å—è –Ω–∞ —Ç—ã, –µ—Å–ª–∏ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –≥—Ä—É–±–æ —Ç—ã –æ—Ç–≤–µ—á–∞–π –≥—Ä—É–±–æ—Å—Ç—å—é"

    async def process_message(self, user_message, history):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏"""
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Groq
            messages = [{"role": "system", "content": self.system_prompt}]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            if history:
                messages.extend(history)
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            messages.append({"role": "user", "content": user_message})
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Groq (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–æ –≤ executor –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏)
            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: self.client.chat.completions.create(
                    model=GROQ_MODEL,
                    messages=messages,
                    max_tokens=MAX_TOKENS,
                    temperature=TEMPERATURE
                )
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            answer = response.choices[0].message.content
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            answer = answer.replace('**', '').replace('*', '').replace('`', '')
            
            # –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –º–∞–ª–µ–Ω—å–∫–æ–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if answer and len(answer) > 0 and answer[0].isupper() and not answer[0:2].isupper():
                answer = answer[0].lower() + answer[1:]
            
            return answer
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ Groq –∑–∞–ø—Ä–æ—Å–∞: {e}")
            return None

    async def analyze_image(self, image_path, user_caption=""):
        """–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è Groq)"""
        try:
            # Groq –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç vision, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ
            if user_caption:
                prompt = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é: '{user_caption}'. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ñ–æ—Ç–æ."
            else:
                prompt = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ñ–æ—Ç–æ."
            
            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: self.client.chat.completions.create(
                    model=GROQ_MODEL,
                    messages=[{"role": "user", "content": prompt}],
                    max_tokens=200,
                    temperature=0.7
                )
            )
            
            answer = response.choices[0].message.content
            answer = answer.replace('**', '').replace('*', '').replace('`', '')
            
            if answer and len(answer) > 0 and answer[0].isupper() and not answer[0:2].isupper():
                answer = answer[0].lower() + answer[1:]
            
            return answer
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            return None


# =============== –û–ë–†–ê–ë–û–¢–ö–ê –ú–ï–î–ò–ê ===============
class MediaHandler:
    @staticmethod
    async def transcribe_voice(file_path):
        """–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        try:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ WAV
            audio = AudioSegment.from_file(file_path)
            wav_path = file_path.replace('.ogg', '.wav')
            audio.export(wav_path, format='wav')

            # –†–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ä–µ—á—å —á–µ—Ä–µ–∑ Google
            recognizer = sr.Recognizer()
            with sr.AudioFile(wav_path) as source:
                audio_data = recognizer.record(source)
                text = recognizer.recognize_google(audio_data, language='ru-RU,en-US')

            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            try:
                os.remove(wav_path)
            except:
                pass

            return text
        except sr.UnknownValueError:
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å")
            return None
        except sr.RequestError as e:
            logger.error(f"–û—à–∏–±–∫–∞ Google Speech API: {e}")
            return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: {e}")
            return None


# =============== TELEGRAM BOT ===============
# =============== TELEGRAM BOT ===============
class TelegramBot:
    def __init__(self, groq_client):
        self.client = TelegramClient(SESSION_NAME, API_ID, API_HASH)
        self.db = Database(DB_FILE)
        self.ai = AIHandler(groq_client)
        self.media = MediaHandler()
        self.me = None
        self.running = True

    # üëá –í–û–¢ –≠–¢–û–¢ –ú–ï–¢–û–î –ù–£–ñ–ù–û –î–û–ë–ê–í–ò–¢–¨ –°–Æ–î–ê (—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏)
    async def keep_online(self):
        """–ü–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å '–≤ —Å–µ—Ç–∏'"""
        while self.running:
            try:
                await self.client(UpdateStatusRequest(offline=False))
                await asyncio.sleep(30)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {e}")
                await asyncio.sleep(10)

    async def start(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"""
        await self.client.start(phone=PHONE)
        self.me = await self.client.get_me()
        logger.info(f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –¥–ª—è: {self.me.first_name} (@{self.me.username})")
        logger.info(f"üì± ID: {self.me.id}")
        logger.info(f"ü§ñ AI: Groq ({GROQ_MODEL})")
        logger.info(f"‚ö° –°–∫–æ—Ä–æ—Å—Ç—å: –ú–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–∞—è!")
        logger.info(f"‚öôÔ∏è –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã: {'–í–∫–ª—é—á–µ–Ω—ã' if ENABLED else '–í—ã–∫–ª—é—á–µ–Ω—ã'}")
        logger.info(f"üë• –ì—Ä—É–ø–ø—ã: {'–ò–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è' if IGNORE_GROUPS else '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è'}")
        logger.info(f"üì∏ –§–æ—Ç–æ: –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è (–±–µ–∑ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ)")

        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        @self.client.on(events.NewMessage(incoming=True))
        async def handle_message(event):
            if self.running:
                await self.process_message(event)

        # üëá –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£ –î–õ–Ø –ó–ê–ü–£–°–ö–ê –û–ù–õ–ê–ô–ù-–°–¢–ê–¢–£–°–ê
        asyncio.create_task(self.keep_online())

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        def signal_handler(signum, frame):
            logger.info("üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...")
            self.running = False
            self.client.disconnect()

        signal.signal(signal.SIGINT, signal_handler)
        signal.signal(signal.SIGTERM, signal_handler)

        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç
        await self.client.run_until_disconnected()

    async def process_message(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∏
            if not ENABLED:
                return

            # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            if event.sender_id == self.me.id:
                return

            # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã
            if event.is_group and IGNORE_GROUPS:
                return

            # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–∞–Ω–∞–ª—ã
            if event.is_channel and IGNORE_CHANNELS:
                return

            chat_id = event.chat_id

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ
            try:
                sender = await event.get_sender()
                sender_name = sender.first_name if hasattr(sender, 'first_name') and sender.first_name else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
            except:
                sender_name = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

            logger.info(f"üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {sender_name} (ID: {chat_id})")

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
            message_text = ""

            # 1. –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if event.text and not event.photo:
                message_text = event.text
                logger.info(f"üí¨ –¢–µ–∫—Å—Ç: {message_text[:50]}...")

            # 2. –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            elif event.voice:
                logger.info("üé§ –ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")

                try:
                    await event.reply("—Å–ª—É—à–∞—é...")
                except:
                    pass

                try:
                    file_path = await event.download_media(file='voice_temp.ogg')
                    transcribed = await self.media.transcribe_voice(file_path)

                    try:
                        os.remove(file_path)
                    except:
                        pass

                    if transcribed:
                        message_text = f"[–≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]: {transcribed}"
                        logger.info(f"‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: {transcribed}")
                    else:
                        await event.reply("–Ω–µ —Å–º–æ–≥ —Ä–∞–∑–æ–±—Ä–∞—Ç—å, –ø–æ–≤—Ç–æ—Ä–∏ —Ç–µ–∫—Å—Ç–æ–º")
                        return
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ: {e}")
                    return

            # 3. –§–æ—Ç–æ
            elif event.photo:
                logger.info("üì∑ –ü–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ")

                try:
                    await event.reply("—Å–º–æ—Ç—Ä—é...")
                except:
                    pass

                try:
                    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ –µ—Å–ª–∏ –µ—Å—Ç—å
                    photo_caption = event.message.message if event.message.message else ""

                    # –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ Groq
                    image_description = await self.ai.analyze_image(None, photo_caption)

                    if image_description:
                        message_text = f"[—Ñ–æ—Ç–æ]: {image_description}"
                        logger.info(f"‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ñ–æ—Ç–æ: {image_description[:50]}...")
                    else:
                        await event.reply("–∫–ª–∞—Å—Å–Ω–æ–µ —Ñ–æ—Ç–æ!")
                        return

                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ: {e}")
                    await event.reply("–∫–ª–∞—Å—Å–Ω–æ–µ —Ñ–æ—Ç–æ!")
                    return

            # 4. –î–æ–∫—É–º–µ–Ω—Ç/–§–∞–π–ª
            elif event.document:
                mime_type = event.document.mime_type if event.document.mime_type else ""

                if 'audio' in mime_type or 'ogg' in mime_type:
                    logger.info("üéµ –ü–æ–ª—É—á–µ–Ω–æ –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–µ")

                    try:
                        await event.reply("—Å–ª—É—à–∞—é...")
                    except:
                        pass

                    try:
                        file_path = await event.download_media(file='audio_temp')
                        transcribed = await self.media.transcribe_voice(file_path)

                        try:
                            os.remove(file_path)
                        except:
                            pass

                        if transcribed:
                            message_text = f"[–∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–µ]: {transcribed}"
                            logger.info(f"‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: {transcribed}")
                        else:
                            await event.reply("–Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∞—É–¥–∏–æ")
                            return
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ: {e}")
                        return
                else:
                    logger.info("üìé –ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª")
                    message_text = "[–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–∞–π–ª]"
                    if event.message.message:
                        message_text += f": {event.message.message}"

            # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if not message_text:
                return

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.db.add_message(chat_id, "user", message_text)

            # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Groq
            history = self.db.get_history(chat_id, limit=10)

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
            try:
                async with self.client.action(chat_id, 'typing'):
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
                    logger.info("ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç...")
                    response = await self.ai.process_message(message_text, history)

                    # –ò–º–∏—Ç–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏
                    if DELAY_BEFORE_REPLY > 0:
                        await asyncio.sleep(DELAY_BEFORE_REPLY)
            except asyncio.CancelledError:
                logger.info("‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ (–±–æ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è)")
                return
            except ConnectionError:
                logger.warning("‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ")
                return

            if response:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                try:
                    await event.reply(response)
                    logger.info(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç–≤–µ—Ç: {response[:50]}...")

                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
                    self.db.add_message(chat_id, "assistant", response)
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
            else:
                logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI")

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)


# =============== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===============
def main():
    print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   Telegram AI Auto-Responder v3.0         ‚ïë
‚ïë   Groq API (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–æ!)      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if API_ID == "YOUR_API_ID" or API_HASH == "YOUR_API_HASH":
        print("""
‚ö†Ô∏è  –ù–ï–û–ë–•–û–î–ò–ú–ê –ù–ê–°–¢–†–û–ô–ö–ê TELEGRAM!

1. –ü–æ–ª—É—á–∏—Ç–µ API_ID –∏ API_HASH:
   üëâ https://my.telegram.org

2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª telegram_ai_bot.py

3. –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏:
   API_ID = "YOUR_API_ID"      ‚Üí  API_ID = "12345678"
   API_HASH = "YOUR_API_HASH"   ‚Üí  API_HASH = "abc..."
   PHONE = "YOUR_PHONE"         ‚Üí  PHONE = "+79991234567"
        """)
        sys.exit(1)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Groq API
    if GROQ_API_KEY == "YOUR_GROQ_API_KEY":
        print("""
‚ö†Ô∏è  –ù–ï–û–ë–•–û–î–ò–ú API –ö–õ–Æ–ß GROQ!

1. –ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á:
   üëâ https://console.groq.com

2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª telegram_ai_bot.py

3. –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫—É:
   GROQ_API_KEY = "YOUR_GROQ_API_KEY"
   
   –ù–∞:
   GROQ_API_KEY = "gsk_–≤–∞—à-–∫–ª—é—á..."

4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ
        """)
        sys.exit(1)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ FFmpeg
    try:
        import subprocess
        result = subprocess.run(["ffmpeg", "-version"], capture_output=True)
        if result.returncode != 0:
            raise FileNotFoundError
    except:
        print("""
‚ö†Ô∏è  FFmpeg –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!

–î–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ FFmpeg:

  Ubuntu/Debian:  sudo apt install ffmpeg
  macOS:          brew install ffmpeg
  Windows:        —Å–∫–∞—á–∞–π—Ç–µ —Å ffmpeg.org

–ë–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –Ω–æ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥—É—Ç.
        """)

    print("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...\n")

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Groq
    groq_client = initialize_groq()

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    bot = TelegramBot(groq_client)

    try:
        asyncio.run(bot.start())
    except KeyboardInterrupt:
        print("\n\n‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (Ctrl+C)")
    except Exception as e:
        logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")


if __name__ == "__main__":
    main()
